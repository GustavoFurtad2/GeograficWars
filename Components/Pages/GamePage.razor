@page "/game/{RoomId?}"
@inject RoomService RoomService
@rendermode InteractiveServer

@using Excubo.Blazor.Canvas
@using Excubo.Blazor.Canvas.Contexts
@using GeograficWars.Game
@using Microsoft.JSInterop

@inject IJSRuntime JS

<PageTitle>Game</PageTitle>
<Canvas @ref="canvas" width="@canvasWidth" height="@canvasHeight" style="display:block; margin:0; padding:0; border:0;"/>

@foreach (Country country in countries)
{
    CountryData countryData = @country.GetCountryData();

    <img id="@countryData.CountryId" src="countries/@countryData.ImagePath" style="display: none;" />
}

@code {

    [Parameter]
    public string? RoomId { get; set; }

    private List<Country>? countries;
    private Canvas? canvas;
    private Game? game;
    private Room? room;
    private CountriesManager? countriesManager;

    private double canvasWidth;
    private double canvasHeight;

    protected override void OnInitialized()
    {
        game = new Game();

        room = RoomService.CreateRoom(RoomId, "room");

        countriesManager = room.GetCountriesManager();

        countries = countriesManager.GetCountries();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        var windowSize = await JS.InvokeAsync<WindowSize>("gameInterop.getWindowSize");

        canvasWidth = windowSize.Width;
        canvasHeight = windowSize.Height;

        await game!.InitializeAsync(canvas!, windowSize);

        await RenderLoop();
    }

    private async Task RenderLoop()
    {
        while (true)
        {
            await game!.Render(countries);
            await InvokeAsync(StateHasChanged);
            await Task.Delay(16);
        }
    }

}
